<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매장 관리</title>
    <script type="module" src="/js/authService.js"></script>
    <style>
        /* ======== 네비게이터 스타일 시작 ======== */
        .nav-container {
          width: 100%;
          background: white;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          position: fixed;
          top: 0;
          left: 0;
          z-index: 100;
        }

        .nav-content {
          max-width: 1200px;
          margin: 0 auto;
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 1rem;
        }

        .nav-logo {
          font-size: 1.5rem;
          font-weight: 600;
          color: #333;
          text-decoration: none;
        }

        .nav-menu {
          display: flex;
          gap: 2rem;
          align-items: center;
        }

        .nav-link {
          color: #666;
          text-decoration: none;
          font-weight: 500;
          padding: 0.5rem 1rem;
          border-radius: 6px;
          transition: all 0.2s;
        }

        .nav-link:hover {
          background: #f5f5f5;
          color: #333;
        }

        .nav-user {
          display: flex;
          align-items: center;
          gap: 1rem;
        }

        .nav-button {
          padding: 0.5rem 1rem;
          border-radius: 6px;
          border: none;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s;
        }

        .nav-button.primary {
          background: #4CAF50;
          color: white;
        }

        .nav-button.primary:hover {
          background: #43A047;
        }

        .mobile-menu {
          display: none;
          padding: 1rem;
          background: white;
          border-top: 1px solid #eee;
        }

        /* 모바일 메뉴 버튼 (기본적으로 숨김) */
        .mobile-only {
          display: none; 
        }

        /* ======== 네비게이터 반응형 스타일 ======== */
        @media (max-width: 768px) {
          .nav-menu, 
          .nav-user {
            display: none;
          }
          
          .mobile-menu {
            display: block;
          }
          
          .mobile-menu .nav-link {
            display: block;
            padding: 0.75rem 0;
          }
          
          /* 모바일에서만 메뉴 버튼 표시 */
          .mobile-only {
            display: block;
          }
        }
        /* ======== 네비게이터 스타일 끝 ======== */

        /* 기존 CSS 스타일 유지 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 80px; /* 네비게이션 바 높이만큼 여백 추가 */
        }
        .grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        .user-list, .store-list {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto; /* 스크롤 가능하도록 수정 */
            max-height: calc(100vh - 200px); /* 최대 높이 제한 */
        }
        .user-item {
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            border: 1px solid transparent; /* 기본 테두리 추가 */
        }
        .user-item:hover {
            background-color: #f5f5f5;
        }
        .user-item.active {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
        }
        .store-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            border: 1px solid transparent; /* 기본 테두리 추가 */
        }
        .store-item:hover {
            background-color: #f5f5f5;
        }
        .store-item label {
            margin-left: 12px;
            cursor: pointer;
            flex: 1;
            word-break: break-word; /* 긴 텍스트 줄바꿈 */
        }
        .store-item input[type="checkbox"] {
            width: 22px; /* 더 크게 만들어 모바일에서 터치 쉽게 */
            height: 22px;
            cursor: pointer;
            flex-shrink: 0; /* 크기 고정 */
        }
        .save-btn {
            background-color: #4CAF50;
            color: white;
            padding: 16px 24px; /* 버튼 크기 키움 */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px; /* 폰트 크기 키움 */
            font-weight: 600;
            margin-top: 20px;
            transition: background-color 0.2s ease;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .save-btn:hover {
            background-color: #45a049;
        }
        .save-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        /* 로딩 인디케이터 스타일 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            margin-top: 16px;
            font-size: 16px;
            color: #333;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 에러 메시지 스타일 */
        .error-message {
            color: #f44336;
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
            background-color: #ffebee;
            display: none;
            border-left: 4px solid #f44336;
            font-weight: 500;
        }
        .error-message.show {
            display: block;
        }
        
        /* 데이터 없음 메시지 */
        .no-data-message {
            text-align: center;
            padding: 30px 15px;
            color: #666;
            font-size: 16px;
            background-color: #f9f9f9;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        /* 모바일 환경을 위한 수정된 반응형 스타일 */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .user-list, .store-list {
                margin-bottom: 20px;
                min-height: 200px; /* 최소 높이 설정 */
                max-height: 400px; /* 모바일에서는 더 작은 최대 높이 */
            }
            .user-item, .store-item {
                padding: 15px; /* 더 큰 터치 영역 */
            }
            .store-item input[type="checkbox"] {
                width: 24px; /* 모바일에서 더 큰 체크박스 */
                height: 24px;
            }
            .hidden {
                display: none !important;
            }
            .mobile-menu.hidden {
                display: none;
            }
            .mobile-menu {
                transition: all 0.3s ease;
            }
            .save-btn {
                padding: 18px 24px; /* 모바일에서 더 큰 버튼 */
                font-size: 20px;
            }
        }
        
        /* 화면 크기가 아주 작은 경우 추가 최적화 */
        @media (max-width: 480px) {
            .container {
                padding: 15px 10px;
            }
            h1, h2 {
                font-size: 1.4em;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이터 시작 -->
    <nav class="nav-container">
        <div class="nav-content">
            <a href="/" class="nav-logo">로고</a>
            <!-- 모바일 전용 메뉴 버튼 -->
            <button id="mobileMenuBtn" class="nav-button mobile-only">
                <span>메뉴</span>
            </button>
            <div class="nav-menu" id="navMenu">
                <a href="/sitemap.html" class="nav-link">사이트맵</a>
                <a href="/dashboard.html" class="nav-link">리뷰관리</a>
                <a href="/admin/store-manager" class="nav-link">영업관리</a>
                <a href="/rules.html" class="nav-link">답글규칙설정</a>
            </div>
            <div class="nav-user">
                <a href="/profile.html" class="nav-link">내 정보</a>
                <button id="logoutBtn" class="nav-button primary">로그아웃</button>
            </div>
        </div>
        <!-- 모바일 확장 메뉴 (기본적으로 숨겨짐) -->
        <div id="mobileMenu" class="mobile-menu hidden">
            <a href="/sitemap.html" class="nav-link">사이트맵</a>
            <a href="/dashboard.html" class="nav-link">리뷰관리</a>
            <a href="/admin/store-manager" class="nav-link">영업관리</a>
            <a href="/rules.html" class="nav-link">답글규칙설정</a>
            <a href="/profile.html" class="nav-link">내 정보</a>
            <button id="mobileLogoutBtn" class="nav-button primary">로그아웃</button>
        </div>
    </nav>
    <!-- 네비게이터 끝 -->

    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">데이터를 불러오는 중...</div>
    </div>

    <div class="container">
        <h1>매장 권한 관리</h1>
        <div id="errorMessage" class="error-message"></div>
        <div class="grid">
            <div class="user-list">
                <h2>사용자 목록</h2>
                <div id="userList"></div>
            </div>
            <div class="store-list">
                <h2>매장 목록</h2>
                <div id="storeList"></div>
                <button id="saveBtn" class="save-btn" disabled>저장</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { authService } from '/js/authService.js';
    
        // StoreManager 초기화 함수
        function initStoreManager() {
            if (!window.StoreManager) {
                class StoreManager {
                    constructor() {
                        this.selectedUserId = null;
                        this.users = [];
                        this.stores = [];
                        this.selectedStores = new Set();
                        this.isLoading = false;
                        
                        this.initElements();
                        this.init();
                    }
    
                    async init() {
                        try {
                            this.showLoading(true);
                            await this.checkAuth();
                            
                            // 명시적 딜레이 추가 (모바일 환경에서 안정성 개선)
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            // 사용자 데이터 로드
                            await this.loadUsers();
                            
                            // 초기화 완료 메시지
                            console.log('StoreManager initialization complete');
                            
                            // 초기 데이터가 비어있는지 확인
                            if (Array.isArray(this.users) && this.users.length === 0) {
                                this.showError('사용자 목록이 비어있습니다. 데이터를 불러올 수 없습니다.');
                            }
                        } catch (error) {
                            this.showError(`초기화 중 오류가 발생했습니다: ${error.message || '알 수 없는 오류'}`);
                            console.error('초기화 에러:', error);
                        } finally {
                            this.showLoading(false);
                            
                            // DOM 모니터링 추가 - 모바일에서 누락된 엘리먼트 탐지
                            setTimeout(() => {
                                if (this.userList && this.userList.children.length === 0) {
                                    console.warn('User list is empty after initialization, attempting re-render');
                                    this.renderUsers();
                                }
                                if (this.storeList && this.storeList.children.length === 0 && this.selectedUserId) {
                                    console.warn('Store list is empty after initialization, attempting reload');
                                    this.loadStores(this.selectedUserId).catch(console.error);
                                }
                            }, 1000);
                        }
                    }
    
                    async checkAuth() {
                        const user = await authService.getCurrentUser();
                        if (!user || user.role !== '운영자') {
                            setTimeout(() => {
                                window.location.href = '/login.html?error=unauthorized';
                            }, 1000);
                            throw new Error('접근 권한이 없습니다.');
                        }
                    }
    
                    initElements() {
                        this.userList = document.getElementById('userList');
                        this.storeList = document.getElementById('storeList');
                        this.saveBtn = document.getElementById('saveBtn');
                        this.errorMessage = document.getElementById('errorMessage');
                        this.loadingIndicator = document.getElementById('loadingIndicator');
                        
                        if (this.saveBtn) {
                            this.saveBtn.addEventListener('click', () => this.saveAssignments());
                        }
                        this.initLogoutHandler();
                        this.initMobileMenu();
                    }
    
                    initMobileMenu() {
                        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                        const mobileMenu = document.getElementById('mobileMenu');
                        
                        if (mobileMenuBtn && mobileMenu) {
                            mobileMenuBtn.addEventListener('click', () => {
                                mobileMenu.classList.toggle('hidden');
                            });
                        }
                    }
    
                    initLogoutHandler() {
                        const logoutBtn = document.getElementById('logoutBtn');
                        const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
                        
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', async () => {
                                await this.handleLogout();
                            });
                        }
    
                        if (mobileLogoutBtn) {
                            mobileLogoutBtn.addEventListener('click', async () => {
                                await this.handleLogout();
                            });
                        }
                    }
                    
                    async handleLogout() {
                        try {
                            this.showLoading(true);
                            await authService.logout();
                            window.location.href = '/login.html';
                        } catch (error) {
                            this.showError('로그아웃 중 오류가 발생했습니다.');
                            console.error('로그아웃 에러:', error);
                            this.showLoading(false);
                        }
                    }
    
                    showLoading(show = true) {
                        this.isLoading = show;
                        if (this.loadingIndicator) {
                            this.loadingIndicator.style.display = show ? 'flex' : 'none';
                        }
                        if (this.saveBtn) {
                            this.saveBtn.disabled = show || !this.selectedUserId;
                        }
                    }
    
                    showError(message) {
                        if (this.errorMessage) {
                            this.errorMessage.textContent = message;
                            this.errorMessage.classList.add('show');
                            setTimeout(() => {
                                this.errorMessage.classList.remove('show');
                            }, 5000);
                        } else {
                            console.error('Error message element not found:', message);
                            alert(`오류: ${message}`);
                        }
                    }
    
                    // StoreManager 클래스 내부
                    async loadUsers() {
                        try {
                            console.log('1. 사용자 목록 로딩 시작');
                            console.log('loadUsers 함수 호출됨');
                            console.log('사용자 목록 API 요청 시작:', '/api/stores/users');
                            console.log('인증 헤더:', authService.getAuthHeader() ? '존재함' : '없음');
                            
                            const response = await fetch('/api/stores/users', {
                                headers: {
                                    'Authorization': authService.getAuthHeader(),
                                    'Accept': 'application/json'
                                }
                            });
                            
                            console.log('2. API 응답:', response.status);
                            
                            if (!response.ok) {
                                throw new Error('사용자 목록 조회 실패');
                            }
                            
                            const users = await response.json();
                            console.log('3. 받은 사용자 데이터:', users);
                            
                            this.users = users;
                            this.renderUsers();
                            
                        } catch (error) {
                            console.error('4. 사용자 로딩 에러:', error);
                            this.showError('사용자 목록을 불러오는데 실패했습니다.');
                        }
                    }
    
                    async loadStores(userId) {
                        try {
                            if (!userId) {
                                console.error('No userId provided to loadStores');
                                return;
                            }
                            
                            this.showLoading(true);
                            const response = await fetch(`/api/stores/user/${userId}/stores`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': authService.getAuthHeader(),
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                credentials: 'include',
                                cache: 'no-store'
                            });
                            
                            if (!response.ok) {
                                console.error('Store list fetch failed:', response.status, response.statusText);
                                const errorText = await response.text().catch(() => '');
                                console.error('Error response:', errorText);
                                
                                // 세션 만료 체크 (401 오류)
                                if (response.status === 401) {
                                    await authService.refreshToken().catch(() => null);
                                    // 토큰 갱신 후 재시도
                                    const retryResponse = await fetch(`/api/stores/user/${userId}/stores`, {
                                        method: 'GET',
                                        headers: {
                                            'Authorization': authService.getAuthHeader(),
                                            'Content-Type': 'application/json',
                                            'Accept': 'application/json'
                                        },
                                        credentials: 'include',
                                        cache: 'no-store'
                                    });
                                    
                                    if (!retryResponse.ok) {
                                        throw new Error(`매장 목록 조회 실패 (${retryResponse.status})`);
                                    }
                                    
                                    const stores = await retryResponse.json();
                                    console.log('Loaded stores for user (after token refresh):', stores);
                                    this.selectedStores = new Set(stores.map(s => s.store_code));
                                    await this.loadAllStores();
                                    return;
                                }
                                
                                throw new Error(`매장 목록 조회 실패 (${response.status})`);
                            }
                            
                            const stores = await response.json();
                            console.log('Loaded stores for user:', stores);
                            
                            if (!Array.isArray(stores)) {
                                console.warn('Expected array but got:', typeof stores);
                                this.selectedStores = new Set();
                            } else {
                                this.selectedStores = new Set(stores.map(s => s.store_code));
                            }
                            
                            await this.loadAllStores();
                        } catch (error) {
                            this.showError(`매장 목록을 불러오는데 실패했습니다: ${error.message}`);
                            console.error('매장 로딩 실패:', error);
                        } finally {
                            this.showLoading(false);
                        }
                    }
    
                    async loadAllStores() {
                        try {
                            console.log('loadAllStores 함수 호출됨');
                            const maxRetries = 2;
                            let lastError = null;
                            
                            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                                try {
                                    if (attempt > 0) {
                                        console.log(`매장 목록 조회 재시도... (${attempt}/${maxRetries})`);
                                        await new Promise(resolve => setTimeout(resolve, 1000)); // 1초 대기
                                    }
                                    console.log('매장 목록 API 요청 시작:', '/api/stores/all');
                                    console.log('인증 헤더:', authService.getAuthHeader() ? '존재함' : '없음');

                                    const response = await fetch('/api/stores/all', {
                                        method: 'GET',
                                        headers: {
                                            'Authorization': authService.getAuthHeader(),
                                            'Content-Type': 'application/json',
                                            'Accept': 'application/json'
                                        },
                                        credentials: 'include',
                                        cache: 'no-store'
                                    });
                                    console.log('API 응답 상태:', response.status, response.statusText);
                                    
                                    if (!response.ok) {
                                        // 401 오류는 토큰 갱신 시도
                                        if (response.status === 401) {
                                            const refreshed = await authService.refreshToken().catch(() => false);
                                            if (refreshed) continue; // 토큰 갱신 성공 시 재시도
                                        }
                                        
                                        console.error('All stores fetch failed:', response.status, response.statusText);
                                        const errorText = await response.text().catch(() => '');
                                        console.error('Error response:', errorText);
                                        throw new Error(`전체 매장 목록 조회 실패 (${response.status})`);
                                    }
                                    
                                    const data = await response.json();
                                    console.log('Loaded all stores:', data);
                                    console.log('매장 목록 API 응답 데이터:', data);
                                    
                                    if (!Array.isArray(data)) {
                                        console.error('Expected array but got:', typeof data);
                                        this.stores = [];
                                    } else {
                                        this.stores = data;
                                    }
                                    
                                    this.renderStores();
                                    return; // 성공하면 함수 종료
                                } catch (error) {
                                    lastError = error;
                                    if (attempt === maxRetries) throw error;
                                }
                            }
                            
                            // 모든 시도 실패
                            throw lastError || new Error('알 수 없는 오류');
                        } catch (error) {
                            this.showError(`매장 목록을 불러오는데 실패했습니다: ${error.message}`);
                            console.error('매장 로딩 실패:', error);
                            
                            // 에러 발생해도 빈 목록으로 렌더링
                            this.stores = [];
                            this.renderStores();
                        }
                    }
    
                    renderUsers() {
                        if (!this.userList) {
                            console.error('User list element not found');
                            return;
                        }
                        
                        console.log('Rendering users, current data:', this.users);
                        
                        // 운영자도 표시하도록 변경 (자기 자신은 표시해야 함)
                        const filteredUsers = Array.isArray(this.users) ? this.users : [];
                        
                        if (filteredUsers.length === 0) {
                            console.warn('No users to display');
                            this.userList.innerHTML = '<div class="no-data-message">표시할 사용자가 없습니다.</div>';
                            return;
                        }
                            
                        this.userList.innerHTML = filteredUsers.map(user => `
                            <div class="user-item ${this.selectedUserId === user.id ? 'active' : ''}"
                                 data-user-id="${user.id}">
                                <div>${user.name || '이름 없음'}</div>
                                <div style="font-size: 0.9em; color: #666;">
                                    ${user.role || '-'} (${user.email || '-'})
                                </div>
                            </div>
                        `).join('');
                        
                        console.log('Rendered user items:', this.userList.querySelectorAll('.user-item').length);
                        
                        // 이벤트 리스너 추가
                        const userItems = this.userList.querySelectorAll('.user-item');
                        userItems.forEach(item => {
                            item.addEventListener('click', () => {
                                const userId = item.dataset.userId;
                                if (userId) {
                                    this.selectUser(userId);
                                }
                            });
                        });
                        
                        // 첫 번째 사용자 자동 선택 (표시 문제 해결)
                        if (filteredUsers.length > 0 && !this.selectedUserId) {
                            console.log('Auto-selecting first user');
                            setTimeout(() => {
                                this.selectUser(filteredUsers[0].id);
                            }, 100);
                        }
                    }
    
                    renderStores() {
                        if (!this.storeList) {
                            console.error('Store list element not found');
                            return;
                        }
                        
                        console.log('Rendering stores, data:', this.stores);
                        
                        if (!Array.isArray(this.stores) || this.stores.length === 0) {
                            this.storeList.innerHTML = '<div class="no-data-message" style="padding: 20px; text-align: center; color: #666;">매장 정보가 없습니다.</div>';
                            if (this.saveBtn) {
                                this.saveBtn.disabled = true;
                            }
                            return;
                        }
                        
                        this.storeList.innerHTML = this.stores.map(store => {
                            // 매장 코드 항상 문자열로 처리
                            const storeCode = String(store.store_code || '');
                            const isSelected = this.selectedStores.has(storeCode);
                            
                            return `
                                <div class="store-item">
                                    <input type="checkbox" 
                                        id="store_${storeCode}"
                                        ${isSelected ? 'checked' : ''}
                                        data-store-code="${storeCode}">
                                    <label for="store_${storeCode}">
                                        ${store.store_name || '이름 없음'} (${storeCode})
                                    </label>
                                </div>
                            `;
                        }).join('');
                        
                        console.log('Rendered store items:', this.storeList.querySelectorAll('.store-item').length);
                        
                        // 이벤트 리스너 추가
                        const checkboxes = this.storeList.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', () => {
                                const storeCode = checkbox.dataset.storeCode;
                                if (storeCode) {
                                    this.toggleStore(storeCode);
                                }
                            });
                        });
                        
                        if (this.saveBtn) {
                            this.saveBtn.disabled = !this.selectedUserId;
                        }
                    }
    
                    async selectUser(userId) {
                        if (this.isLoading || !userId) return;
                        this.selectedUserId = userId;
                        this.renderUsers();
                        await this.loadStores(userId);
                    }
    
                    toggleStore(storeCode) {
                        if (this.isLoading || !storeCode) return;
                        
                        if (this.selectedStores.has(storeCode)) {
                            this.selectedStores.delete(storeCode);
                        } else {
                            this.selectedStores.add(storeCode);
                        }
                        
                        // 체크박스 상태 업데이트
                        const checkbox = document.getElementById(`store_${storeCode}`);
                        if (checkbox) {
                            checkbox.checked = this.selectedStores.has(storeCode);
                        }
                    }
    
                    async saveAssignments() {
                        if (!this.selectedUserId || this.isLoading) return;
    
                        try {
                            this.showLoading(true);
                            const user = this.users.find(u => u.id === this.selectedUserId);
                            if (!user) {
                                throw new Error('선택된 사용자를 찾을 수 없습니다.');
                            }
                            
                            const stores = Array.from(this.selectedStores).map(storeCode => ({
                                store_code: storeCode,
                                role_type: user.role
                            }));
    
                            const response = await fetch('/api/stores/assignments', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': authService.getAuthHeader()
                                },
                                body: JSON.stringify({
                                    userId: this.selectedUserId,
                                    stores: stores
                                })
                            });
    
                            if (!response.ok) throw new Error('저장 실패');
                            alert('매장 권한이 저장되었습니다.');
                            
                            // 저장 후 데이터 새로고침
                            await this.loadStores(this.selectedUserId);
                        } catch (error) {
                            this.showError('매장 권한 저장에 실패했습니다.');
                            console.error('저장 실패:', error);
                        } finally {
                            this.showLoading(false);
                        }
                    }
                }
                
                window.StoreManager = StoreManager;
                window.storeManager = new StoreManager();
            } else if (!window.storeManager) {
                window.storeManager = new window.StoreManager();
            }
        }
    
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Page load started, checking auth...');
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'flex';
                }
                
                // 1. 인증 상태 확인 (최대 3번 시도)
                let isAuthed = false;
                let authCheckAttempts = 0;
                const maxAuthAttempts = 3;
                
                while (!isAuthed && authCheckAttempts < maxAuthAttempts) {
                    try {
                        isAuthed = await authService.isAuthenticated();
                        if (isAuthed) break;
                        
                        console.log(`Auth check attempt ${authCheckAttempts + 1} failed, retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        authCheckAttempts++;
                    } catch (authError) {
                        console.warn('Auth check error:', authError);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        authCheckAttempts++;
                    }
                }
                
                if (!isAuthed) {
                    console.error(`Failed to authenticate after ${maxAuthAttempts} attempts`);
                    window.location.href = '/login.html?error=auth_failed';
                    return;
                }
                
                // 2. 사용자 정보 확인
                let user = null;
                let userCheckAttempts = 0;
                const maxUserAttempts = 3;
                
                while (!user && userCheckAttempts < maxUserAttempts) {
                    try {
                        user = await authService.getCurrentUser();
                        if (user) break;
                        
                        console.log(`User data fetch attempt ${userCheckAttempts + 1} failed, retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        userCheckAttempts++;
                    } catch (userError) {
                        console.warn('User data fetch error:', userError);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        userCheckAttempts++;
                    }
                }

                if (!user) {
                    console.error(`Failed to fetch user data after ${maxUserAttempts} attempts`);
                    window.location.href = '/login.html?error=no_user_data';
                    return;
                }
                
                console.log('Current user:', user);

                // 3. 권한 확인
                if (user.role !== '운영자') {
                    console.log('Access denied, user role:', user.role);
                    alert('접근 권한이 없습니다. 관리자에게 문의하세요.');
                    window.location.href = '/dashboard.html';
                    return;
                }
                
                // 4. StoreManager 초기화
                console.log('Auth validated, initializing store manager...');
                initStoreManager();
                
            } catch (error) {
                console.error('Global initialization error:', error);
                
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = '초기화 중 오류가 발생했습니다: ' + (error.message || '알 수 없는 오류');
                    errorMessage.classList.add('show');
                } else {
                    alert('오류가 발생했습니다: ' + (error.message || '알 수 없는 오류'));
                }
                
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // 오류 표시 후 잠시 대기한 다음 리다이렉트
                setTimeout(() => {
                    window.location.href = '/login.html?error=' + encodeURIComponent(error.message || 'unknown');
                }, 3000);
            }
        });
        
        // 뒤로가기 및 페이지 가시성 변경 처리
        window.addEventListener('pageshow', (event) => {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                console.log('Page was loaded from cache (back/forward navigation)');
                window.location.reload();
            }
        });
        
        // 모바일에서 탭 전환 후 돌아올 때 처리
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('Page became visible, checking state...');
                
                // 페이지가 5초 이상 숨겨져 있었으면 상태 새로 고침
                const lastVisibleTime = window.lastVisibleTime || 0;
                const currentTime = Date.now();
                const hiddenDuration = currentTime - lastVisibleTime;
                
                if (lastVisibleTime > 0 && hiddenDuration > 5000) {
                    console.log(`Page was hidden for ${hiddenDuration}ms, refreshing state...`);
                    
                    // StoreManager가 이미 초기화되어 있으면 데이터만 새로고침
                    if (window.storeManager) {
                        window.storeManager.loadUsers().catch(console.error);
                    } else {
                        // 아니면 페이지 새로고침
                        window.location.reload();
                    }
                }
            } else {
                // 페이지가 숨겨질 때 타임스탬프 저장
                window.lastVisibleTime = Date.now();
            }
        });
        
        // 모바일 터치 이벤트 최적화
        document.addEventListener('touchstart', () => {}, {passive: true});
        
        // 온라인/오프라인 상태 모니터링
        window.addEventListener('online', () => {
            console.log('Network connection restored');
            if (window.storeManager) {
                window.storeManager.loadUsers().catch(console.error);
            }
        });
        
        window.addEventListener('offline', () => {
            console.log('Network connection lost');
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = '네트워크 연결이 끊겼습니다. 연결 상태를 확인해주세요.';
                errorMessage.classList.add('show');
                setTimeout(() => errorMessage.classList.remove('show'), 5000);
            }
        });
    </script>
</body>
</html>